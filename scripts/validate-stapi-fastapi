#!/usr/bin/env sh

set -e

scripts="$(cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
root=$(dirname "$scripts")

uv run fastapi dev "$root/stapi-fastapi/tests/application.py" >/dev/null 2>&1 &
server_pid=$!

set +e
"$scripts"/wait-for-it.sh localhost:8000 -- test 0
wait_result=$?

uv run pystapi-validator/tests/validate_api.py --html=validation-report.html --self-contained-html
validation_result=$?
set -e

kill $(pgrep -P $server_pid)
if [ $wait_result -eq 0 ] && [ $validation_result -eq 0 ]; then
    echo "Validated OK!"
else
    exit 1
fi
